## 新建 `builder` 实例

Docker for Linux 不支持构建 `arm` 架构镜像，我们可以运行一个新的容器让其支持该特性

创建一个多架构的构建实例

```bash
docker buildx create --use \
  --name multi-arch-builder \
  --driver docker-container \
  --platform linux/amd64,linux/arm64 \
  --buildkitd-flags "--oci-worker-net=cni" \
  --buildkitd-flags '--allow-insecure-entitlement security.insecure' \
  --driver-opt image=moby/buildkit:buildx-stable-1
```

## 构建镜像

新建 Dockerfile 文件

```bash
# syntax=docker-registry.local.liaosirui.com:5000/third/docker.io/docker/dockerfile:1.4.3

FROM --platform=$TARGETPLATFORM alpine

RUN uname -a > /os.txt

CMD cat /os.txt
```

使用这个实例进行构建

```bash
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  --file ./build/docker/Dockerfile \
  --progress plain \
  --pull \
  --push \
  -t docker-registry.local.liaosirui.com:5000/test/alpine:master_latest \
  .
```

- `--push` 参数表示将构建好的镜像推送到仓库

在不同架构运行该镜像，可以得到该架构的信息

```bash
# arm64
> docker pull --platform arm64 docker-registry.local.liaosirui.com:5000/test/alpine:master_latest
> docker run -it --rm docker-registry.local.liaosirui.com:5000/test/alpine:master_latest
Linux buildkitsandbox 5.14.0-70.30.1.el9_0.x86_64 #1 SMP PREEMPT Thu Nov 3 20:29:04 UTC 2022 aarch64 Linux

# arm64 可以使用
#   docker create --name test-arm64 docker-registry.local.liaosirui.com:5000/test/alpine:master_latest
#   docker cp test-arm64:/os.txt ./os.txt
#   cat ./os.txt
#   Linux buildkitsandbox 5.14.0-70.30.1.el9_0.x86_64 #1 SMP PREEMPT Thu Nov 3 20:29:04 UTC 2022 aarch64 Linux

# amd64
> docker pull --platform amd64 docker-registry.local.liaosirui.com:5000/test/alpine:master_latest
> docker run -it --rm docker-registry.local.liaosirui.com:5000/test/alpine:master_latest
Linux buildkitsandbox 5.14.0-70.30.1.el9_0.x86_64 #1 SMP PREEMPT Thu Nov 3 20:29:04 UTC 2022 x86_64 Linux
```

